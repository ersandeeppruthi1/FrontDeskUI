<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        let classMap = [];
        var apiURL = "";
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Information Form</title>
    <link href="https://localhost:44309/css/Default/bootstrap.min.css" rel="stylesheet">
    <link href="https://localhost:44309/css/Default/select2.min.css" rel="stylesheet">
    <link href="https://localhost:44309/css/Default/font-awesome-all.min.css" rel="stylesheet">
    <link href="https://localhost:44309/css/Default/simple-line-icons.min.css" rel="stylesheet">
    <link href="https://localhost:44309/css/app.css" rel="stylesheet">

    <!-- JS Libraries -->
    <script src="https://localhost:44309/css/Default/jquery.min.js"></script>
    <script src="https://localhost:44309/css/Default/moment.min.js"></script>
    <script src="https://localhost:44309/css/Default/bootstrap.bundle.min.js"></script>
    <script src="https://localhost:44309/css/Default/select2.min.js"></script>
    <script src="https://localhost:44309/css/Default/bootstrap-select.min.js"></script>
    <script src="https://localhost:44309/css/Default/popper.min.js"></script>
    <script src="https://localhost:44309/css/Default/dayjs.js"></script>
    <script src="https://localhost:44309/css/Default/JSpdf.umd.min.js"></script>
    <script src="https://localhost:44309/css/Default/JSpdf.plugin.autotable.min.js"></script>

    <!-- Custom JS -->
    <script src="https://localhost:44309/JS/entityPage.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/controls.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/listcontrols.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/formHandler.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/pageLoader.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/Master/DBHandler.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/VastuBill/VastuBillPDFExporter.js?id=3"></script>
    <script src="https://localhost:44309/css/Default/bootstrap.bundle.min.js"></script>
    <script src="https://localhost:44309/JS/utility.js?id=5"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.0/jquery-ui.css"
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://localhost:44309/css/Default/pdfmake.min.js"></script>
    <script src="https://localhost:44309/css/Default/vfs_fonts.js"></script>

    <script src="https://localhost:44309/css/Default/xlsx.full.min.js"></script>
    <script src="https://localhost:44309/css/Default/moment.min.js"></script>

    <script src="../../JS/system/html2canvas.min.js"></script>
    <script src="../../JS/system/JsBarcode.all.min.js"></script>



</head>
<body>

    <div class="container body-content">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <div class="container mt-4">
            <form>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-4">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    <div class="col-md-4">
                        <label for="DoctorFilter" class="form-label">Doctors</label>
                        <select class="form-select" id="DoctorFilter">
                            <option value="all" selected>All Doctors</option>
                        </select>
                    </div>
                </div>
            </form>

            <div class="mt-4 d-flex flex-wrap">
                <button type="button" class="btn btn-primary me-2 mb-2 mx-2" id="searchButton" onclick="fetchData()">
                    Search
                </button>

                <button type="button" class="btn btn-danger me-2 mb-2 mx-2" id="exportPdfButton" onclick="exportTableToPdfPatientNew()">
                    Export PDF
                </button>

                <button type="button" class="btn btn-danger me-2 mb-2 mx-2" id="exportPdfButton" onclick="exportTableToPdfPatientNew1()">
                    Export PDF1
                </button>

                <button type="button" class="btn btn-primary mb-2 mx-2" id="exportCsvButton" onclick="exportToCSVPatient()">
                    Export CSV
                </button>
            </div>

        </div>

        <div id="patienDetailInfoFull"></div>

        <style>
            tr:nth-child(even) {
                background-color: #f2f2f2;
            }

            tr {
            }

            .caption2 {
                caption-side: top;
                text-align: center;
                font-weight: bolder;
                color: black;
                padding: 2px;
            }

            .tblPatient td, .transactionTable td {
                border: 1px solid #ccc;
                /* padding: 4px; */
            }
        </style>
    </div>

    <script>

        // Function to fetch data from the API
        async function fetchData() {
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;

            let filterCondition = ` date >= '${startDate}'`;
            filterCondition += ` AND date <= '${endDate}'`;

            const data = await DBHandler.fetchEntityRecords(
                'frontdeskpatientrecord',
                'id,patientid,serialnumber,amount,patientname,age,gender,phone,doctorname,totaltest,paymentmethod,date,optiongroup',
                'createdon',
                'desc',
                filterCondition,
                true
            );

            patientCache = data;
            createTable();
        }

        // === Dropdown Handling ===
        function buildDoctorFilter(groupedData, prevSelected) {
            const doctorFilter = document.getElementById("DoctorFilter");
            doctorFilter.innerHTML = ""; // clear options

            // Add "All Doctors" first
            const allOption = document.createElement("option");
            allOption.value = "all";
            allOption.textContent = "All Doctors";
            doctorFilter.appendChild(allOption);

            // Add doctors from data
            Object.keys(groupedData).forEach(doctorName => {
                const opt = document.createElement("option");
                opt.value = doctorName;
                opt.textContent = doctorName;
                doctorFilter.appendChild(opt);
            });

            // Restore selection if possible
            if (doctorFilter.querySelector(`option[value="${prevSelected}"]`)) {
                doctorFilter.value = prevSelected;
            } else {
                doctorFilter.value = "all";
            }
        }

        // === Totals Section ===
        function buildTotalsSection(data) {
            const totalAmount = data.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            const cashAmount = data.reduce((sum, e) => sum + ((e.paymentmethod === "cash") ? parseFloat(e.amount) : 0), 0);
            const onlineAmount = data.reduce((sum, e) => sum + ((e.paymentmethod === "online") ? parseFloat(e.amount) : 0), 0);

            const onlineAshishAmount = data.reduce((sum, e) => sum + ((e.paymentmethod === "Ashish Online") ? parseFloat(e.amount) : 0), 0);

            const div = document.createElement("div");
            div.id = "totalAmountContainer";
            //div.style.display = "inline-block";

            div.innerHTML = `
            <table class="table" style="">
                <thead class="table-light">
                    <tr>
                        <th>Type</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Cash</td>
                        <td id="CashAmount">${formatIndianCurrency(cashAmount)}</td>
                    </tr>
                    <tr>
                        <td>Online</td>
                        <td id="OnlineAmount">${formatIndianCurrency(onlineAmount)}</td>
                    </tr>
                      <tr>
                        <td>Ashish Online</td>
                        <td id="OnlineAmount">${formatIndianCurrency(onlineAshishAmount)}</td>
                    </tr>
                    <tr>
                        <td><b>Total</b></td>
                        <td id="totalAmount"><b>${formatIndianCurrency(totalAmount)}</b></td>
                    </tr>
                </tbody>
            </table>
        `;
            return div;
        }


        // === Table Rendering ===
        function buildDoctorTable(doctorName, appointments, idTable) {
            const table = document.createElement("table");
            table.className = "table";
            table.style.width = "100%";
            table.style.marginTop = "15px";
            table.style.lineHeight = "7px";
            table.id = "tbl" + idTable;

            // Caption
            const caption = document.createElement("caption");
            caption.textContent = doctorName;
            caption.className = "mt-2 caption2";
            caption.style.border = "1px solid black";
            caption.style.captionSide = "top";
            caption.style.lineHeight = "20px";
            caption.onclick = () => exportTableToPdfPatientNewWithDiv(table.id);
            table.appendChild(caption);

            const tbody = document.createElement("tbody");
            table.appendChild(tbody);

            // Header
            const header = document.createElement("tr");
            header.innerHTML = `
                        <td style="width:130px;">Date</td>
                        <td>Count</td>
                        <td>Amount</td>
                    `;
            tbody.appendChild(header);

            let sumAmount = 0, totalCount = 0;
            const existingDates = {};

            appointments.forEach(app => {
                app.date = formatDateDisplay(app.date);

                const formattedDate = formatDateDisplay(app.date);

                const amount = parseFloat(app.amount) || 0;
                const count = parseInt(app.totalTest) || 1;

                if (!existingDates[formattedDate]) {
                    existingDates[formattedDate] = { count, amount };

                    const row = document.createElement("tr");
                    row.innerHTML = `
                                <td>${formattedDate}</td>
                                <td>${count}</td>
                                <td>${formatIndianCurrency(amount)}</td>
                            `;
                    tbody.appendChild(row);
                } else {
                    existingDates[formattedDate].count += count;
                    existingDates[formattedDate].amount += amount;

                    // Update row
                    [...tbody.rows].forEach(r => {
                        if (r.cells[0] && r.cells[0].innerText === formattedDate) {
                            r.cells[1].innerText = existingDates[formattedDate].count;
                            r.cells[2].innerText = formatIndianCurrency(existingDates[formattedDate].amount);
                        }
                    });
                }

                sumAmount += amount;
                totalCount += count;
            });

            // Totals row
            const totalRow = document.createElement("tr");
            totalRow.innerHTML = `
                        <td style="font-weight:bold;text-align:right;padding-right:10px;">Total</td>
                        <td style="font-weight:bold;">${totalCount}</td>
                        <td style="font-weight:bold;">${formatIndianCurrency(sumAmount)}</td>
                    `;
            tbody.appendChild(totalRow);

            return table;
        }

        function createTable() {
            const data = patientCache || [];
            const container = document.getElementById("patienDetailInfoFull");
            container.innerHTML = ""; // reset

            const doctorFilter = document.getElementById("DoctorFilter");
            const prevSelected = doctorFilter ? doctorFilter.value : "All";

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = "<p>No records found.</p>";
                buildDoctorFilter({}, prevSelected);
                return;
            }

            // Group records by doctor
            const groupedData = {};
            data.forEach(item => {
                const doctor = item.doctorname || "Unknown Doctor";
                if (!groupedData[doctor]) groupedData[doctor] = [];
                groupedData[doctor].push(item);
            });

            buildDoctorFilter(groupedData, prevSelected);

            let filteredDoctors = groupedData;
            if (prevSelected && prevSelected !== "all") {
                filteredDoctors = { [prevSelected]: groupedData[prevSelected] || [] };
            }

            const totalsData = (prevSelected && prevSelected !== "all")
                ? filteredDoctors[prevSelected]
                : data;

            container.appendChild(buildTotalsSection(totalsData));

            const tablesWrapper = document.createElement("div");
            tablesWrapper.classList.add("mt-3");

            let idTable = 0;
            Object.keys(filteredDoctors).forEach(doctorName => {
                idTable++;
                const table = buildDoctorTable(doctorName, filteredDoctors[doctorName], idTable);
                tablesWrapper.appendChild(table);
            });

            container.appendChild(tablesWrapper);
        }

        function exportToCSVPatient() {
            if (!patientCache || patientCache.length === 0) {
                alert("No data available to export.");
                return;
            }

            // Define the header
            const headers = [
                "Date",
                "Doctor Name",
                "Patient Name",
                "Amount",
                "Payment Method",
                "Gender",
                "Option Group",
                "Phone",
                "Total Test",
                "Serial Number"
            ];

            // Build CSV rows
            const rows = patientCache.map(item => [
                formatDateDisplay(item.date), // Ensure date is formatted
                item.doctorname || "",
                item.patientname || "",
                item.amount || "", // ✅ Added amount
                item.paymentmethod || "",
                item.gender || "",
                item.optiongroup || "",
                item.phone || "",
                item.totaltest || "",
                item.serialnumber || ""
            ]);

            // Combine header + rows
            const csvContent = [headers.join(","), ...rows.map(r => r.map(val => `"${val}"`).join(","))].join("\n");

            // File name with date range
            const startDate = document.getElementById("startDate").value || "Start";
            const endDate = document.getElementById("endDate").value || "End";
            const fileName = `PatientReport_${startDate}_to_${endDate}.csv`;

            // Download CSV
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        function exportTableToPdfPatientNew() {
            exportHtmlToPdf('patienDetailInfoFull');
        }

        function exportTableToPdfPatientNew1() {
            exportHtmlToPdf1('patienDetailInfoFull');
        }

        async function exportHtmlToPdf1(selector, fileName = "export.pdf") {
            const element = document.getElementById(selector);
            if (!element) {
                console.error("Element not found:", selector);
                return;
            }

            // Custom Table CSS (your requested style)
            const tableCSS = `
        <style>
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 14px;
            }
            table th, table td {
                border: 1px solid #000;
                padding: 6px 8px;
                text-align: left;
                font-size: 16px;
            }
            table th {
                background: #fff;       /* No color */
                color: #000;            /* Black text */
                font-size: 16px;        /* Bigger heading */
                font-weight: bold;
            }
        </style>
    `;

            // Add CSS + element HTML
            const bodyHtml = tableCSS + element.outerHTML;
            // Prepare request payload
            const payload = {
                HeaderHTML: "",
                FooterHTML: "",
                BodyHTML: bodyHtml,
                DynamicProperties: {
                    Name: fileName.replace(".pdf", ""),
                    PageWidth: 210,
                    PageHeight: 297,
                    TopMargin: 10,
                    BottomMargin: 10,
                    LeftMargin: 10,
                    RightMargin: 10
                }
            };

            try {
                const response = await fetch("/api/ConvertPDF", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    alert("Failed to generate PDF: " + response.statusText);
                    return;
                }

                const blob = await response.blob();

                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();

                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

            } catch (err) {
                console.error("Error:", err);
            }
        }




        function onDomLoaded() {
            const today = new Date();
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            $("#startDate").val(getDefaultValue('currentMonthStartDate'));
            $("#endDate").val(getDefaultValue('currentMonthEndDate'));
            $('#DoctorFilter').select2();
            fetchData();
        }

        $(document).ready(async () => {
            onDomLoaded();
        });

    </script>


</body>
</html>
