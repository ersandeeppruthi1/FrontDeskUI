<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        let classMap = [];
        //var apiURL = "https://sittest.mahantsatishdassjicharitable.com";
        var apiURL = "";
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belt Stock Return</title>
    <link href="https://localhost:44309/css/Default/bootstrap.min.css" rel="stylesheet">
    <link href="https://localhost:44309/css/Default/select2.min.css" rel="stylesheet">
    <link href="https://localhost:44309/css/Default/font-awesome-all.min.css" rel="stylesheet">
    <link href="https://localhost:44309/css/Default/simple-line-icons.min.css" rel="stylesheet">
    <link href="https://localhost:44309/css/app.css" rel="stylesheet">

    <!-- JS Libraries -->
    <script src="https://localhost:44309/css/Default/jquery.min.js"></script>
    <script src="https://localhost:44309/css/Default/moment.min.js"></script>
    <script src="https://localhost:44309/css/Default/bootstrap.bundle.min.js"></script>
    <script src="https://localhost:44309/css/Default/select2.min.js"></script>
    <script src="https://localhost:44309/css/Default/bootstrap-select.min.js"></script>
    <script src="https://localhost:44309/css/Default/popper.min.js"></script>
    <script src="https://localhost:44309/css/Default/dayjs.js"></script>
    <script src="https://localhost:44309/css/Default/JSpdf.umd.min.js"></script>
    <script src="https://localhost:44309/css/Default/JSpdf.plugin.autotable.min.js"></script>

    <!-- Custom JS -->
    <script src="https://localhost:44309/JS/entityPage.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/controls.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/listcontrols.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/formHandler.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/pageLoader.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/Master/DBHandler.js?id=3" type="module"></script>
    <script src="https://localhost:44309/JS/VastuBill/VastuBillPDFExporter.js?id=3"></script>
    <script src="https://localhost:44309/css/Default/bootstrap.bundle.min.js"></script>
    <script src="https://localhost:44309/JS/utility.js?id=5"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.0/jquery-ui.css"
          crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

    <div class="container body-content">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <div class="container mt-4">
            <form>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" onchange="refreshGrid()">
                    </div>
                    <div class="col-md-4">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate" onchange="refreshGrid()">
                    </div>
                </div>
            </form>
        </div>

        <div id="patienDetailInfoFull">
            <div id="searchAndActionsContainer"></div>
            <table class="table table-bordered" id="tableBody">
                <thead id="headingrow"></thead>
                <tbody></tbody>
            </table>

        </div>
    </div>

    <script>
        let beltCache = [];

        async function refreshGrid() {
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;

            let filterCondition = `purchasedate >= '${startDate}' AND purchasedate <= '${endDate}'`;

            const data = await DBHandler.fetchEntityRecords(
                'frontdeskstockitemin',
                '*',
                'createdon',
                'desc',
                filterCondition,
                true
            );

            beltCache = data;
            renderBeltTable();
        }

        function renderBeltTable() {
            const thead = document.querySelector("#tableBody thead");
            thead.innerHTML = `
                        <thead>
                            <th>Belt</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Expiry Date</th>
                            <th>Bill Date</th>
                            <th>Payment Type</th>
                        </thead>
                    `;

            const tbody = document.querySelector("#tableBody tbody");
            tbody.innerHTML = "";

            let totalAmount = 0;

            beltCache.forEach(item => {
                let amount = parseFloat(item.amount) ||
                    (parseFloat(item.itemstock) * parseFloat(item.price));
                totalAmount += amount;

                const row = `
                            <tr>
                                <td>${item.stockitemname || ""}</td>
                                <td>${item.itemstock || 0}</td>
                                <td>${(parseFloat(item.price) || 0).toFixed(2)}</td>
                                <td>${item.expiry ? formatDateInGrid(item.expiry) : ""}</td>
                                <td>${item.purchasedate ? formatDateInGrid(item.purchasedate) : ""}</td>
                                <td>${item.paymenttype || "Unknown"}</td>
                            </tr>
                        `;
                tbody.innerHTML += row;
            });

            if (!tbody.innerHTML) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">No records found</td></tr>`;
            }
        }

        function initializePage() {
            $("#startDate").val(getDefaultValue('currentMonthStartDate'));
            $("#endDate").val(getDefaultValue('currentMonthEndDate'));

            createSearchAndActions('searchAndActionsContainer');
            refreshGrid();
        }

        $(document).ready(() => {
            initializePage();
        });
    </script>

</body>
</html>
